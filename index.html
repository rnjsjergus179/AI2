<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D ìºë¦­í„° HUD, ë‹¬ë ¥ & ë§í’ì„  ì±„íŒ…</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; overflow: hidden; }

    /* === ìš°ì¸¡ HUD (ì±„íŒ…) === */
    #right-hud {
      position: fixed;
      top: 10%;
      right: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.8);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }
    #chat-log {
      flex: 1 1 auto;
      display: none;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 5px;
      margin-top: 10px;
      border-radius: 3px;
      background: #fff;
    }
    #chat-input-area {
      display: flex;
      margin-top: 10px;
    }
    #chat-input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
    }

    /* === Google ì§€ë„ (HUDâ€‘4) === */
    #hud-4 {
      flex: 0 0 200px;
      margin-top: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
      background: #fff;
    }
    #hud-4 h4 { text-align: center; font-size: 13px; background:#f0f0f0; padding:4px 0; }
    #hud-4 iframe { width: 100%; height: calc(100% - 22px); border: 0; }

    /* === ì¢Œì¸¡ HUD (ìº˜ë¦°ë”) === */
    #left-hud {
      position: fixed;
      top: 10%;
      left: 1%;
      width: 20%;
      padding: 1%;
      background: rgba(255,255,255,0.9);
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 20;
      max-height: 80vh;
      overflow-y: auto;
    }
    #left-hud h3 { margin-bottom: 5px; }
    #calendar-container { margin-top: 10px; }
    #calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    #calendar-header button{ padding:2px 6px; font-size:12px; cursor:pointer; }
    #month-year-label{ font-weight:bold; font-size:14px; }
    #year-select{ font-size:12px; padding:2px; margin-left:5px; }
    #calendar-actions{ margin-top:5px; text-align:center; }
    #calendar-actions button{ margin:2px; padding:5px 8px; font-size:12px; cursor:pointer; }
    #calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
    #calendar-grid div{ background:#fff; border:1px solid #ccc; border-radius:4px; min-height:25px; font-size:10px; padding:2px; position:relative; cursor:pointer; }
    #calendar-grid div:hover{ background:#e9e9e9; }
    .day-number{ position:absolute; top:2px; left:2px; font-weight:bold; font-size:10px; }
    .event{ margin-top:14px; font-size:8px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* === ìº”ë²„ìŠ¤ & ë§í’ì„  === */
    #canvas{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; display:block; }
    #speech-bubble{ position:fixed; background:white; padding:5px 10px; border-radius:10px; font-size:12px; display:none; z-index:30; white-space:pre-line; pointer-events:none; box-shadow:0 2px 5px rgba(0,0,0,0.2); }

    /* === íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ === */
    #tutorial-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:white; display:flex; justify-content:center; align-items:center; z-index:100; opacity:0; transition:opacity 1s ease-in-out; pointer-events:none; }
    #tutorial-content{ text-align:center; padding:20px; background:rgba(255,255,255,0.1); border-radius:10px; max-width:600px; }
    #tutorial-content h2{ margin-bottom:15px; }
    #tutorial-content p{ margin:10px 0; font-size:14px; }

    /* === ë²„ì „ ì…€ë ‰í„° === */
    #version-select{ position:fixed; bottom:10px; left:10px; z-index:50; }
    #version-select select{ padding:5px; font-size:12px; }

    @media (max-width:480px){
      #right-hud, #left-hud{ width:90%; left:5%; right:5%; top:5%; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script>
    /* ========================= ê³µí†µ ìœ í‹¸ ========================= */
    document.addEventListener("contextmenu", e=>e.preventDefault());
    let blockUntil = 0;
    document.addEventListener("copy", e=>{
      e.preventDefault();
      let txt=window.getSelection().toString().replace(/396bfaf4974ab9c336b3fb46e15242da/g,"HIDDEN");
      e.clipboardData.setData("text/plain",txt);
      if(Date.now()<blockUntil) return;
      blockUntil=Date.now()+3600000;
      showSpeechBubbleInChunks("1ì‹œê°„ë™ì•ˆ ì°¨ë‹¨ë©ë‹ˆë‹¤.");
    });

    const weatherKey="396bfaf4974ab9c336b3fb46e15242da";
    let currentWeather="";

    function saveFile(){
      const blob=new Blob(["íŒŒì¼ ì €ì¥ ì™„ë£Œ"],{type:"text/plain;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);a.download="saved_file.txt";document.body.appendChild(a);a.click();a.remove();
    }
    function saveCalendar(){
      const days=new Date(currentYear,currentMonth+1,0).getDate();
      const data={};
      for(let d=1;d<=days;d++){
        const el=document.getElementById(`event-${currentYear}-${currentMonth+1}-${d}`);
        if(el&&el.textContent.trim()!=="") data[`${currentYear}-${currentMonth+1}-${d}`]=el.textContent;
      }
      const str="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(data,null,2));
      const a=document.createElement("a");
      a.href=str;a.download="calendar_events.json";document.body.appendChild(a);a.click();a.remove();
    }

    /* ========================= ì±„íŒ… ì²˜ë¦¬ ========================= */
    async function sendChat(){
      const inputEl=document.getElementById("chat-input");
      const msg=inputEl.value.trim();
      if(!msg) return;
      if(Date.now()<blockUntil){ showSpeechBubbleInChunks("1ì‹œê°„ë™ì•ˆ ì°¨ë‹¨ë©ë‹ˆë‹¤."); inputEl.value=""; return; }
      const lower=msg.toLowerCase();
      let reply="";
      if(lower.includes("íŒŒì¼ ì €ì¥í•´ì¤˜")){ reply="ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. íŒŒì¼ ì €ì¥í•˜ê² ìŠµë‹ˆë‹¤."; saveFile(); }
      else if((lower.includes("ìº˜ë¦°ë”")&&lower.includes("ì €ì¥"))||lower.includes("ì¼ì •ì €ì¥")||lower.includes("í•˜ë£¨ì¼ê³¼ì €ì¥")){ reply="ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. ìº˜ë¦°ë” ì €ì¥í•˜ê² ìŠµë‹ˆë‹¤."; saveCalendar(); }
      else if(lower.includes("ë‚ ì”¨")&&(lower.includes("ì•Œë ¤")||lower.includes("ì–´ë•Œ")||lower.includes("ë­ì•¼")||lower.includes("ì–´ë–»ê²Œ")||lower.includes("ë§‘ì•„"))){ reply=await getWeather(); }
      else if(lower.includes("ê¸°ë¶„")&&lower.includes("ì¢‹ì•„")){
        reply="ì •ë§ìš”!? ì €ë„ ì •ë§ ê¸°ë¶„ì¢‹ì•„ìš”ğŸ˜";
        const orig=leftEye.material.color.getHex(); leftEye.material.color.set(0xffff00); rightEye.material.color.set(0xffff00);
        setTimeout(()=>{ leftEye.material.color.set(orig); rightEye.material.color.set(orig); },500);
        const oL=leftBrow.rotation.x,oR=rightBrow.rotation.x; const id=setInterval(()=>{ const ang=Math.sin(Date.now()*0.005)*0.3; leftBrow.rotation.x=oL+ang; rightBrow.rotation.x=oR+ang; },50); setTimeout(()=>{clearInterval(id); leftBrow.rotation.x=oL; rightBrow.rotation.x=oR;},3000);
      }
      else if(lower.includes("ì•ˆë…•")){
        reply="ì•ˆë…•í•˜ì„¸ìš”, ì£¼ì¸ë‹˜! ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”?";
        characterGroup.children[7].rotation.z=Math.PI/4; setTimeout(()=>{characterGroup.children[7].rotation.z=0;},1000);
      }
      else if(lower.includes("ìºë¦­í„° ë„Œ ëˆ„êµ¬ì•¼")) reply="ì €ëŠ” ë‹¹ì‹ ì˜ ê°œì¸ ë¹„ì„œì—ìš”.";
      else if(lower.includes("ì¼ì •")) reply="ìº˜ë¦°ë”ëŠ” ì™¼ìª½ì—ì„œ í™•ì¸í•˜ì„¸ìš”.";
      else if(lower.includes("ìºë¦­í„° ì¶¤ì¶°ì¤˜")){
        reply="ì¶¤ì¶œê²Œìš”!";
        if(danceInterval) clearInterval(danceInterval);
        danceInterval=setInterval(()=>{ characterGroup.children[7].rotation.z=Math.sin(Date.now()*0.01)*Math.PI/4; head.rotation.y=Math.sin(Date.now()*0.01)*Math.PI/8; },50);
        setTimeout(()=>{ clearInterval(danceInterval); characterGroup.children[7].rotation.z=0; head.rotation.y=0; },3000);
      }
      else if(lower.includes("í•˜ë£¨ì¼ì • ì‚­ì œí•´ì¤˜")||lower.includes("ì¼ì • ì‚­ì œ")){
        const day=prompt("ì‚­ì œí•  í•˜ë£¨ì¼ì •ì˜ ë‚ ì§œ(ì¼)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 15):");
        if(day){ const el=document.getElementById(`event-${currentYear}-${currentMonth+1}-${parseInt(day)}`); if(el){ el.textContent=""; reply=`${currentYear}-${currentMonth+1}-${day} ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`; } else reply="í•´ë‹¹ ë‚ ì§œì˜ ì…€ì´ ì—†ìŠµë‹ˆë‹¤."; }
        else reply="ë‚ ì§œë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
      else if(lower.includes("ì…ë ¥í•˜ê²Œ ë³´ì—¬ì¤˜")||lower.includes("ì¼ì • ì…ë ¥")){
        const day=prompt("ì¼ì •ì„ ì…ë ¥í•  ë‚ ì§œ(ì¼)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 15):");
        if(day){ const el=document.getElementById(`event-${currentYear}-${currentMonth+1}-${parseInt(day)}`); if(el){ const txt=prompt(`${currentYear}-${currentMonth+1}-${day} ì¼ì • ì…ë ¥:`); if(txt){ el.textContent=el.textContent?el.textContent+"; "+txt:txt; reply=`${currentYear}-${currentMonth+1}-${day}ì— ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`; } else reply="ì¼ì •ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."; } else reply="í•´ë‹¹ ë‚ ì§œì˜ ì…€ì´ ì—†ìŠµë‹ˆë‹¤."; }
        else reply="ë‚ ì§œë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
      else reply="ì£„ì†¡í•´ìš”, ì˜ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ í•œ ë²ˆ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”?";
      showSpeechBubbleInChunks(reply);
      inputEl.value="";
    }

    async function getWeather(){
      try{ const res=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Seoul&appid=${weatherKey}&units=metric&lang=kr`);
        if(!res.ok) throw new Error(); const d=await res.json(); currentWeather=d.weather[0].description; return `ì˜¤ëŠ˜ Seoulì˜ ë‚ ì”¨ëŠ” ${currentWeather}ì´ë©°, ì˜¨ë„ëŠ” ${d.main.temp}Â°Cì…ë‹ˆë‹¤.`; }
      catch{ currentWeather=""; return "ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; }
    }

    /* ========================= Three.js ì´ˆê¸°í™” ========================= */
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
    const renderer=new THREE.WebGLRenderer({canvas:document.getElementById("canvas"),alpha:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    camera.position.set(5,5,10); camera.lookAt(0,0,0);
    const dirLight=new THREE.DirectionalLight(0xffffff,1); dirLight.position.set(5,10,7).normalize(); scene.add(dirLight);
    scene.add(new THREE.AmbientLight(0x333333));

    /* === íƒœì–‘/ë‹¬ === */
    const sunMat=new THREE.MeshStandardMaterial({color:0xffcc00,emissive:0xff9900,transparent:true,opacity:0});
    const sun=new THREE.Mesh(new THREE.SphereGeometry(1.5,64,64),sunMat); scene.add(sun);
    const moonMat=new THREE.MeshStandardMaterial({color:0xcccccc,emissive:0x222222,transparent:true,opacity:1});
    const moon=new THREE.Mesh(new THREE.SphereGeometry(1.2,64,64),moonMat); scene.add(moon);

    /* === ë³„/ë°˜ë”§ë¶ˆ === */
    const stars=[],fireflies=[];
    for(let i=0;i<200;i++){ const s=new THREE.Mesh(new THREE.SphereGeometry(0.03,8,8),new THREE.MeshBasicMaterial({color:0xffffff})); s.position.set((Math.random()-0.5)*100,(Math.random()-0.5)*60,-20); scene.add(s); stars.push(s);}    
    for(let i=0;i<60;i++){ const f=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8),new THREE.MeshBasicMaterial({color:0xffff99})); f.position.set((Math.random()-0.5)*40,(Math.random()-0.5)*20,-10); scene.add(f); fireflies.push(f);}    

    /* === ì§€ë©´ === */
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(400,400,128,128),new THREE.MeshStandardMaterial({color:0x808080,roughness:1})); floor.rotation.x=-Math.PI/2; floor.position.y=-2; scene.add(floor);

    /* === ë°°ê²½ ê±´ë¬¼/ì§‘ === */
    const bgGrp=new THREE.Group(); scene.add(bgGrp);
    function createBuilding(w,h,d,c){
      const g=new THREE.Group(); const box=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshStandardMaterial({color:c,roughness:0.7,metalness:0.1})); g.add(box);
      const winMat=new THREE.MeshStandardMaterial({color:0x87CEEB});
      for(let y=3;y<h-1;y+=2){ for(let x=-w/2+0.5;x<w/2;x+=1){ const win=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.8,0.1),winMat); win.position.set(x,y-h/2,d/2+0.01); g.add(win);} }
      const door=new THREE.Mesh(new THREE.BoxGeometry(1,2,0.1),new THREE.MeshStandardMaterial({color:0x8B4513})); door.position.set(0,-h/2+1,d/2+0.01); g.add(door);
      return g; }
    function createHouse(w,h,d,base,roof){ const g=new THREE.Group(); const b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshStandardMaterial({color:base,roughness:0.8})); b.position.y=-2+h/2; g.add(b); const r=new THREE.Mesh(new THREE.ConeGeometry(w*0.8,h*0.6,4),new THREE.MeshStandardMaterial({color:roof,roughness:0.8})); r.position.y=-2+h+h*0.3; r.rotation.y=Math.PI/4; g.add(r); const winMat=new THREE.MeshStandardMaterial({color:0xFFFFE0}); const w1=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.1),winMat);w1.position.set(-w/4,-2+h/2,d/2+0.01);const w2=w1.clone(); w2.position.x=w/4; g.add(w1,w2); const door=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,0.1),new THREE.MeshStandardMaterial({color:0x8B4513})); door.position.set(0,-2+h/4,d/2+0.01); g.add(door); return g; }
    for(let i=0;i<20;i++){ const w=Math.random()*4+4,h=Math.random()*20+20,d=Math.random()*4+4; const b=createBuilding(w,h,d,0x555555); const col=i%10,row=Math.floor(i/10); b.position.set(-50+col*10,-2+h/2,-30-row*20); bgGrp.add(b);}    
    for(let i=0;i<10;i++){ const w=Math.random()*4+6,h=Math.random()*4+6,d=Math.random()*4+6; const hse=createHouse(w,h,d,0xa0522d,0x8b0000); hse.position.set(-40+i*10,0,-10); bgGrp.add(hse);}    

    /* === ê°€ë¡œë“± === */
    function createStreetlight(){ const g=new THREE.Group(); const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,4,8),new THREE.MeshBasicMaterial({color:0x333333})); pole.position.y=2; g.add(pole); const lamp=new THREE.Mesh(new THREE.SphereGeometry(0.2,8,8),new THREE.MeshBasicMaterial({color:0xffcc00})); lamp.position.y=4.2; g.add(lamp); const light=new THREE.PointLight(0xffcc00,1,10); light.position.set(0,4.2,0); g.add(light); return g; }
    const street=createStreetlight(); street.position.set(1,-2,0); scene.add(street);

    /* === ë¹„/êµ¬ë¦„/ë²ˆê°œ === */
    const rainGrp=new THREE.Group(); scene.add(rainGrp);
    (function initRain(){ const cnt=2000; const geo=new THREE.BufferGeometry(); const pos=new Float32Array(cnt*3); for(let i=0;i<cnt;i++){ pos[i*3]=(Math.random()*200-100); pos[i*3+1]=Math.random()*100; pos[i*3+2]=(Math.random()*200-100);} geo.setAttribute("position",new THREE.BufferAttribute(pos,3)); const mat=new THREE.PointsMaterial({color:0xaaaaee,size:0.1,transparent:true,opacity:0.6}); rainGrp.add(new THREE.Points(geo,mat)); })(); rainGrp.visible=false;
    const cloudGrp=new THREE.Group(); scene.add(cloudGrp);
    (function(){ const cloud=new THREE.Group(); const cm=new THREE.MeshLambertMaterial({color:0xffffff,transparent:true,opacity:0.9}); const s1=new THREE.Mesh(new THREE.SphereGeometry(2,32,32),cm); const s2=new THREE.Mesh(new THREE.SphereGeometry(1.8,32,32),cm); s2.position.set(2.2,0.7,0); const s3=new THREE.Mesh(new THREE.SphereGeometry(2.1,32,32),cm); s3.position.set(-2.2,0.5,0); cloud.add(s1,s2,s3); cloudGrp.add(cloud); cloudGrp.position.set(0,10,-20);
      cloudGrp.userData.move=()=>{ cloud.position.x+=0.02; if(cloud.position.x>10) cloud.position.x=-10; };})();
    const lightning=new THREE.PointLight(0xffffff,0,500); lightning.position.set(0,50,0); scene.add(lightning);

    /* === ìºë¦­í„° === */
    const characterGroup=new THREE.Group();
    const body=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,0.5),new THREE.MeshStandardMaterial({color:0x00cc66})); characterGroup.add(body);
    const head=new THREE.Mesh(new THREE.SphereGeometry(0.5,32,32),new THREE.MeshStandardMaterial({color:0xffcc66})); head.position.y=1.2; characterGroup.add(head);
    const eyeMat=new THREE.MeshBasicMaterial({color:0x000000});
    const leftEye=new THREE.Mesh(new THREE.SphereGeometry(0.07,16,16),eyeMat); leftEye.position.set(-0.2,1.3,0.45); characterGroup.add(leftEye);
    const rightEye=leftEye.clone(); rightEye.position.x=0.2; characterGroup.add(rightEye);
    const mouth=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.05,0.05),new THREE.MeshStandardMaterial({color:0xff3366})); mouth.position.set(0,1.1,0.51); characterGroup.add(mouth);
    const leftBrow=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.05,0.05),eyeMat); leftBrow.position.set(-0.2,1.45,0.45); characterGroup.add(leftBrow);
    const rightBrow=leftBrow.clone(); rightBrow.position.x=0.2; characterGroup.add(rightBrow);
    const armMat=body.material; const lArm=new THREE.Mesh(new THREE.BoxGeometry(0.2,1,0.2),armMat); lArm.position.set(-0.7,0.4,0); const rArm=lArm.clone(); rArm.position.x=0.7; characterGroup.add(lArm,rArm);
    const legMat=new THREE.MeshStandardMaterial({color:0x3366cc}); const lLeg=new THREE.Mesh(new THREE.BoxGeometry(0.3,1,0.3),legMat); lLeg.position.set(-0.35,-1,0); const rLeg=lLeg.clone(); rLeg.position.x=0.35; characterGroup.add(lLeg,rLeg);
    characterGroup.position.y=-1; scene.add(characterGroup);
    const charLight=new THREE.PointLight(0xffee88,1,15); scene.add(charLight);

    /* === ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ === */
    let danceInterval=null;
    function updateWeatherEffects(){ if(currentWeather.includes("ë¹„")||currentWeather.includes("ì†Œë‚˜ê¸°")) rainGrp.visible=true; else rainGrp.visible=false; cloudGrp.visible=currentWeather.includes("êµ¬ë¦„"); }
    function updateLightning(){ if(currentWeather.includes("ë²ˆê°œ")||currentWeather.includes("ë‡Œìš°")){ if(Math.random()<0.001){ lightning.intensity=5; setTimeout(()=>{lightning.intensity=0;},100); } } }
    function updateBubblePosition(){ const bubble=document.getElementById("speech-bubble"); const pos=new THREE.Vector3(); head.getWorldPosition(pos); pos.project(camera); bubble.style.left=((pos.x*0.5+0.5)*window.innerWidth)+"px"; bubble.style.top=((1-(pos.y*0.5+0.5))*window.innerHeight-50)+"px"; }
    function animate(){ requestAnimationFrame(animate);
      const now=new Date();
      const headPos=new THREE.Vector3(); head.getWorldPosition(headPos);
      const totalMin=now.getHours()*60+now.getMinutes(); const angle=(totalMin/1440)*Math.PI*2; const radius=3;
      sun.position.set(headPos.x+Math.cos(angle)*radius,headPos.y+Math.sin(angle)*radius,headPos.z);
      moon.position.set(headPos.x+Math.cos(angle+Math.PI)*radius,headPos.y+Math.sin(angle+Math.PI)*radius,headPos.z);
      const t=now.getHours()+now.getMinutes()/60; let sunOp=0,moonOp=0; if(t<6){moonOp=1;} else if(t<7){sunOp=t-6;moonOp=1-(t-6);} else if(t<17){sunOp=1;} else if(t<18){sunOp=1-(t-17); moonOp=t-17;} else{moonOp=1;} sun.material.opacity=sunOp; moon.material.opacity=moonOp;
      const day=(t>=7&&t<17);
      scene.background=new THREE.Color(day?0x87CEEB:0x000033);
      stars.forEach(s=>s.visible=!day); fireflies.forEach(f=>f.visible=!day);
      street.traverse(c=>{ if(c instanceof THREE.PointLight) c.intensity=day?0:1; });
      charLight.position.copy(characterGroup.position).add(new THREE.Vector3(0,5,0)); charLight.intensity=day?0:1;
      cloudGrp.userData.move();
      updateWeatherEffects(); updateLightning(); updateBubblePosition();
      renderer.render(scene,camera);
    } animate();

    /* ========================= ìº˜ë¦°ë” ========================= */
    let currentYear,currentMonth;
    function populateYearSelect(){ const sel=document.getElementById("year-select"); sel.innerHTML=""; for(let y=2020;y<=2070;y++){ const opt=document.createElement("option"); opt.value=y; opt.textContent=y; if(y===currentYear) opt.selected=true; sel.appendChild(opt);} }
    function renderCalendar(y,m){ const grid=document.getElementById("calendar-grid"); grid.innerHTML=""; document.getElementById("month-year-label").textContent=`${y}ë…„ ${m+1}ì›”`;
      ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(d=>{ const el=document.createElement("div"); el.style.fontWeight="bold"; el.style.textAlign="center"; el.textContent=d; grid.appendChild(el); });
      const firstDay=new Date(y,m,1).getDay(); const days=new Date(y,m+1,0).getDate(); for(let i=0;i<firstDay;i++) grid.appendChild(document.createElement("div"));
      for(let d=1;d<=days;d++){ const cell=document.createElement("div"); cell.innerHTML=`<div class='day-number'>${d}</div><div class='event' id='event-${y}-${m+1}-${d}'></div>`; cell.addEventListener("click",()=>{ const txt=prompt(`${y}-${m+1}-${d} ì¼ì • ì…ë ¥:`); if(txt){ const ev=document.getElementById(`event-${y}-${m+1}-${d}`); ev.textContent=ev.textContent?ev.textContent+"; "+txt:txt; } }); grid.appendChild(cell);} }
    function initCalendar(){ const now=new Date(); currentYear=now.getFullYear(); currentMonth=now.getMonth(); populateYearSelect(); renderCalendar(currentYear,currentMonth);
      document.getElementById("prev-month").onclick=()=>{ currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar(currentYear,currentMonth);} ;
      document.getElementById("next-month").onclick=()=>{ currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar(currentYear,currentMonth);} ;
      document.getElementById("year-select").onchange=e=>{ currentYear=parseInt(e.target.value); renderCalendar(currentYear,currentMonth);} ;
      document.getElementById("delete-day-event").onclick=()=>{ const day=prompt("ì‚­ì œí•  í•˜ë£¨ì¼ì •ì˜ ë‚ ì§œ(ì¼)ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 15):"); if(day){ const el=document.getElementById(`event-${currentYear}-${currentMonth+1}-${parseInt(day)}`); if(el){ el.textContent=""; alert(`${currentYear}-${currentMonth+1}-${day} ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);} else alert("í•´ë‹¹ ë‚ ì§œì˜ ì…€ì´ ì—†ìŠµë‹ˆë‹¤."); } };
      document.getElementById("save-calendar").onclick=saveCalendar;
    }

    /* ========================= ê¸°íƒ€ ========================= */
    function showSpeechBubbleInChunks(txt,chSize=15,delay=3000){ const bubble=document.getElementById("speech-bubble"); const chunks=[]; for(let i=0;i<txt.length;i+=chSize) chunks.push(txt.slice(i,i+chSize)); let idx=0; (function next(){ if(idx<chunks.length){ bubble.textContent=chunks[idx]; bubble.style.display="block"; idx++; setTimeout(next,delay);} else setTimeout(()=>bubble.style.display="none",3000);} )(); }
    function showTutorial(){ const ov=document.getElementById("tutorial-overlay"); ov.style.display="flex"; setTimeout(()=>ov.style.opacity="1",10); setTimeout(()=>{ ov.style.opacity="0"; setTimeout(()=>ov.style.display="none",1000); },4000); }
    function changeVersion(ver){ if(ver==="1.3") window.location.reload(); else if(ver==="latest") alert("ìµœì‹  ë²„ì „ìœ¼ë¡œ ì´ë™í•˜ë ¤ë©´ í•´ë‹¹ URLì„ ì…ë ¥í•˜ì„¸ìš”."); }

    /* ========================= ì´ˆê¸° ì´ë²¤íŠ¸ ========================= */
    window.addEventListener("DOMContentLoaded",()=>{ document.getElementById("chat-input").addEventListener("keydown",e=>{ if(e.key==="Enter") sendChat(); }); initCalendar(); showTutorial(); });
    window.addEventListener("resize",()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
  </script>
</head>
<body>
  <!-- ===== ìš°ì¸¡ HUD (ì±„íŒ… + ì§€ë„) ===== -->
  <div id="right-hud">
    <h3>ì±„íŒ…ì°½</h3>
    <div id="chat-log"></div>
    <div id="chat-input-area"><input type="text" id="chat-input" placeholder="ì±„íŒ… ì…ë ¥..." /></div>
    <div id="hud-4"><h4>Google ì§€ë„</h4><iframe src="https://maps.google.com/maps?hl=ko&q=Seoul&z=11&output=embed" title="Google Maps"></iframe></div>
  </div>

  <!-- ===== ì¢Œì¸¡ HUD (ìº˜ë¦°ë”) ===== -->
  <div id="left-hud">
    <h3>ìº˜ë¦°ë”</h3>
    <div id="calendar-container">
      <div id="calendar-header"><button id="prev-month">â—€</button><span id="month-year-label"></span><button id="next-month">â–¶</button><select id="year-select"></select></div>
      <div id="calendar-actions"><button id="delete-day-event">í•˜ë£¨ì¼ì • ì‚­ì œ</button><button id="save-calendar">ë°”íƒ•í™”ë©´ ì €ì¥</button></div>
      <div id="calendar-grid"></div>
    </div>
  </div>

  <div id="speech-bubble"></div>
  <div id="tutorial-overlay"><div id="tutorial-content"><h2>ì‚¬ìš©ë²• ì•ˆë‚´</h2><p><strong>ìºë¦­í„°:</strong> ì±„íŒ…ì°½ì— "ì•ˆë…•", "ìºë¦­í„° ì¶¤ì¶°ì¤˜" ë“±ì„ ì…ë ¥í•´ ë³´ì„¸ìš”.</p><p><strong>ì±„íŒ…ì°½:</strong> ì˜¤ë¥¸ìª½ì—ì„œ "ë‚ ì”¨ ì•Œë ¤ì¤˜", "íŒŒì¼ ì €ì¥í•´ì¤˜" ë“±ìœ¼ë¡œ ëª…ë ¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><p><strong>ìº˜ë¦°ë”:</strong> ì™¼ìª½ì—ì„œ ë‚ ì§œë¥¼ í´ë¦­í•´ ì¼ì •ì„ ì¶”ê°€í•˜ê±°ë‚˜, ë²„íŠ¼ìœ¼ë¡œ ì €ì¥/ì‚­ì œí•˜ì„¸ìš”.</p></div></div>
  <div id="version-select"><select onchange="changeVersion(this.value)"><option value="latest">ìµœì‹  ë²„ì „</option><option value="1.3">êµ¬ë²„ì „ 1.3</option></select></div>
  <canvas id="canvas"></canvas>
</body>
</html>
