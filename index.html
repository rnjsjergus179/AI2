<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>3D 캐릭터 HUD, 달력 & 말풍선 채팅</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; overflow: hidden; }

    /* 오른쪽 HUD */
    #right-hud {
      position: fixed; top: 10%; right: 1%; width: 20%; padding: 1%;
      background: rgba(255,255,255,0.8); border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 20;
    }
    #chat-log {
      display: none; height: 100px; overflow-y: scroll;
      border: 1px solid #ccc; padding: 5px; margin-top: 10px;
      border-radius: 3px; background: #fff;
    }
    #chat-input-area {
      display: flex; margin-top: 10px;
    }
    #chat-input {
      flex: 1; padding: 5px; font-size: 14px;
    }
    /* HUD3: Google 지도 iframe */
    #hud3 {
      margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;
      overflow: hidden;
    }
    #hud3 h4 {
      font-size: 12px; background: #f0f0f0; padding: 4px; margin: 0;
    }
    #hud3 iframe {
      width: 100%; height: 150px; border: 0;
    }

    /* 왼쪽 HUD (캘린더) */
    #left-hud {
      position: fixed; top: 10%; left: 1%; width: 20%; padding: 1%;
      background: rgba(255,255,255,0.9); border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 20;
      max-height: 80vh; overflow-y: auto;
    }
    #left-hud h3 { margin-bottom: 5px; }
    #calendar-container { margin-top: 10px; }
    #calendar-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 5px;
    }
    #calendar-header button {
      padding: 2px 6px; font-size: 12px; cursor: pointer;
    }
    #month-year-label { font-weight: bold; font-size: 14px; }
    #year-select {
      font-size: 12px; padding: 2px; margin-left: 5px;
    }
    #calendar-actions {
      margin-top: 5px; text-align: center;
    }
    #calendar-actions button {
      margin: 2px; padding: 5px 8px; font-size: 12px; cursor: pointer;
    }
    #calendar-grid {
      display: grid; grid-template-columns: repeat(7,1fr); gap: 2px;
    }
    #calendar-grid div {
      background: #fff; border: 1px solid #ccc; border-radius: 4px;
      min-height: 25px; font-size: 10px; padding: 2px;
      position: relative; cursor: pointer;
    }
    #calendar-grid div:hover { background: #e9e9e9; }
    .day-number {
      position: absolute; top: 2px; left: 2px;
      font-weight: bold; font-size: 10px;
    }
    .event {
      margin-top: 14px; font-size: 8px; color: #333;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* Three.js 캔버스 */
    #canvas {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1; display: block;
    }
    /* 말풍선 */
    #speech-bubble {
      position: fixed; background: white; padding: 5px 10px;
      border-radius: 10px; font-size: 12px; display: none;
      z-index: 30; white-space: pre-line; pointer-events: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* 튜토리얼 오버레이 */
    #tutorial-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); color: white; display: flex;
      justify-content: center; align-items: center; z-index: 100;
      opacity: 0; transition: opacity 1s ease-in-out; pointer-events: none;
    }
    #tutorial-content {
      text-align: center; padding: 20px; background: rgba(255,255,255,0.1);
      border-radius: 10px; max-width: 600px;
    }
    #tutorial-content h2 { margin-bottom: 15px; }
    #tutorial-content p { margin: 10px 0; font-size: 14px; }

    /* 버전 셀렉터 */
    #version-select {
      position: fixed; bottom: 10px; left: 10px; z-index: 50;
    }
    #version-select select {
      padding: 5px; font-size: 12px;
    }

    @media (max-width: 480px) {
      #right-hud, #left-hud {
        width: 90%; left: 5%; right: 5%; top: 5%;
      }
    }
  </style>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    let blockUntil = 0;
    document.addEventListener("copy", e => {
      e.preventDefault();
      let txt = window.getSelection().toString()
        .replace(/396bfaf4974ab9c336b3fb46e15242da/g,"HIDDEN");
      e.clipboardData.setData("text/plain", txt);
      if (Date.now() < blockUntil) return;
      blockUntil = Date.now() + 3600000;
      showSpeechBubbleInChunks("1시간동안 차단됩니다.");
    });
    const weatherKey = "396bfaf4974ab9c336b3fb46e15242da";
    let currentWeather = "";

    function saveFile() {
      const b = new Blob(["파일 저장 완료"], {type:"text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download="saved_file.txt";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function saveCalendar() {
      const days = new Date(currentYear, currentMonth+1, 0).getDate();
      let data = {};
      for(let d=1;d<=days;d++){
        const ev = document.getElementById(`event-${currentYear}-${currentMonth+1}-${d}`);
        if(ev && ev.textContent) data[`${currentYear}-${currentMonth+1}-${d}`] = ev.textContent;
      }
      const str = "data:text/json," + encodeURIComponent(JSON.stringify(data,null,2));
      const a=document.createElement("a");
      a.href=str; a.download="calendar_events.json";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    async function sendChat(){
      const inp=document.getElementById("chat-input");
      const txt=inp.value.trim();
      if(!txt) return;
      if(Date.now()<blockUntil){
        showSpeechBubbleInChunks("1시간동안 차단됩니다.");
        inp.value="";return;
      }
      let resp="";
      const low=txt.toLowerCase();
      if(low.includes("파일 저장해줘")){ resp="파일 저장합니다."; saveFile(); }
      else if((low.includes("캘린더")&&low.includes("저장"))||low.includes("일정저장")||low.includes("하루일과저장")){
        resp="캘린더 저장합니다."; saveCalendar();
      }
      else if(low.includes("날씨")&&(low.includes("알려")||low.includes("어때")||low.includes("맑아"))){
        resp=await getWeather();
      }
      else if(low.includes("안녕")){ resp="안녕하세요!"; }
      else{ resp="죄송해요, 잘 이해하지 못했어요."; }
      showSpeechBubbleInChunks(resp);
      inp.value="";
    }

    async function getWeather(){
      try{
        const city="Seoul";
        const url=`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${weatherKey}&units=metric&lang=kr`;
        const r=await fetch(url); if(!r.ok) throw "";
        const d=await r.json();
        return `오늘 ${city}의 날씨: ${d.weather[0].description}, ${d.main.temp}°C`;
      }catch{
        return "날씨 정보를 가져오지 못했습니다.";
      }
    }

    function showSpeechBubbleInChunks(text, n=15, delay=3000){
      const b=document.getElementById("speech-bubble"), arr=[];
      for(let i=0;i<text.length;i+=n) arr.push(text.slice(i,i+n));
      let idx=0;
      (function next(){
        if(idx<arr.length){
          b.textContent=arr[idx++]; b.style.display="block";
          setTimeout(next,delay);
        } else setTimeout(()=>b.style.display="none",3000);
      })();
    }

    window.addEventListener("DOMContentLoaded",()=>{
      document.getElementById("chat-input")
        .addEventListener("keydown",e=>{ if(e.key==="Enter") sendChat(); });
    });
    window.addEventListener("resize",()=>{
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    });

    // Three.js scene
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
    const renderer=new THREE.WebGLRenderer({canvas:document.getElementById("canvas"),alpha:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    camera.position.set(5,5,10); camera.lookAt(0,0,0);
    scene.add(new THREE.DirectionalLight(0xffffff,1));
    scene.add(new THREE.AmbientLight(0x333333));

    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene,camera);
    }
    animate();

    // Calendar
    let currentYear,currentMonth;
    function initCalendar(){
      const now=new Date();
      currentYear=now.getFullYear(); currentMonth=now.getMonth();
      populateYearSelect(); renderCalendar(currentYear,currentMonth);
      document.getElementById("prev-month")
        .addEventListener("click",()=>{ currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(currentYear,currentMonth);});
      document.getElementById("next-month")
        .addEventListener("click",()=>{ currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(currentYear,currentMonth);});
      document.getElementById("year-select")
        .addEventListener("change",e=>{ currentYear=parseInt(e.target.value); renderCalendar(currentYear,currentMonth); });
      document.getElementById("delete-day-event")
        .addEventListener("click",()=>{
          const d=prompt("삭제할 날짜(일) 입력:"); if(d){
            const n=parseInt(d);
            const ev=document.getElementById(`event-${currentYear}-${currentMonth+1}-${n}`);
            if(ev){ ev.textContent=""; alert("삭제되었습니다."); }
            else alert("해당 날짜가 없습니다.");}
        });
      document.getElementById("save-calendar").addEventListener("click",saveCalendar);
    }
    function populateYearSelect(){
      const sel=document.getElementById("year-select");
      sel.innerHTML="";
      for(let y=2020;y<=2070;y++){
        const o=document.createElement("option");
        o.value=y; o.textContent=y; if(y===currentYear) o.selected=true;
        sel.appendChild(o);
      }
    }
    function renderCalendar(y,m){
      const mn=["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"];
      document.getElementById("month-year-label").textContent=`${y}년 ${mn[m]}`;
      const grid=document.getElementById("calendar-grid");
      grid.innerHTML="";
      ["일","월","화","수","목","금","토"].forEach(d=>{
        const th=document.createElement("div");
        th.style.fontWeight="bold"; th.style.textAlign="center"; th.textContent=d;
        grid.appendChild(th);
      });
      const first=new Date(y,m,1).getDay();
      for(let i=0;i<first;i++) grid.appendChild(document.createElement("div"));
      const days=new Date(y,m+1,0).getDate();
      for(let d=1;d<=days;d++){
        const cell=document.createElement("div");
        cell.innerHTML=`<div class="day-number">${d}</div><div class="event" id="event-${y}-${m+1}-${d}"></div>`;
        cell.addEventListener("click",()=>{
          const t=prompt(`${y}-${m+1}-${d} 일정 입력:`); if(t){
            const ev=document.getElementById(`event-${y}-${m+1}-${d}`);
            ev.textContent+=ev.textContent?"; "+t:t;
          }
        });
        grid.appendChild(cell);
      }
    }

    function showTutorial(){
      const ov=document.getElementById("tutorial-overlay");
      ov.style.display="flex"; setTimeout(()=>ov.style.opacity="1",10);
      setTimeout(()=>{ ov.style.opacity="0"; setTimeout(()=>ov.style.display="none",1000); },4000);
    }

    function changeVersion(v){
      if(v==="1.3") window.location.href=window.location.href;
      else if(v==="latest") alert("최신 버전으로 이동하려면 URL을 입력하세요.");
    }

    window.addEventListener("load",()=>{
      initCalendar();
      showTutorial();
    });
  </script>
</head>
<body>
  <div id="right-hud">
    <h3>채팅창</h3>
    <div id="chat-log"></div>
    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="채팅 입력..." />
    </div>
    <div id="hud3">
      <h4>HUD3: 지도</h4>
      <iframe
        src="https://www.google.com/maps?q=Seoul&output=embed"
        allowfullscreen>
      </iframe>
    </div>
  </div>

  <div id="left-hud">
    <h3>캘린더</h3>
    <div id="calendar-container">
      <div id="calendar-header">
        <button id="prev-month">◀</button>
        <span id="month-year-label"></span>
        <button id="next-month">▶</button>
        <select id="year-select"></select>
      </div>
      <div id="calendar-actions">
        <button id="delete-day-event">하루일정 삭제</button>
        <button id="save-calendar">바탕화면 저장</button>
      </div>
      <div id="calendar-grid"></div>
    </div>
  </div>

  <div id="speech-bubble"></div>

  <div id="tutorial-overlay">
    <div id="tutorial-content">
      <h2>사용법 안내</h2>
      <p><strong>캐릭터:</strong> 채팅창에 "안녕", "캐릭터 춤춰줘" 등을 입력해 보세요.</p>
      <p><strong>채팅창:</strong> 오른쪽에서 "날씨 알려줘", "파일 저장해줘" 등으로 명령할 수 있습니다.</p>
      <p><strong>캘린더:</strong> 왼쪽에서 날짜를 클릭해 일정을 추가하거나, 버튼으로 저장/삭제하세요.</p>
    </div>
  </div>

  <div id="version-select">
    <select onchange="changeVersion(this.value)">
      <option value="latest">최신 버전</option>
      <option value="1.3">구버전 1.3</option>
    </select>
  </div>

  <canvas id="canvas"></canvas>
</body>
</html>
